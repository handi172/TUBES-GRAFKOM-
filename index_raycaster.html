<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Document</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }
  </style>
</head>

<body>
  <button id="lock" style="position: absolute">Test</button>
  <script src="node_modules/three/build/three.js"></script>
  <script src="node_modules/three/examples/js/controls/PointerLockControls.js"></script>
  <script src="node_modules/three/examples/js/controls/TransformControls.js"></script>
  <script src="node_modules/three/examples/js/controls/OrbitControls.js"></script>
  <script src="node_modules/cannon/build/cannon.js"></script>
  <script src="node_modules/cannon/tools/threejs/CannonDebugRenderer.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fflate@0.7.3/umd/index.min.js"></script>
  <script>
    var scene = new THREE.Scene();
    scene.background = new THREE.Color(0xffffff);
    var camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 1000);

    var renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    document.body.appendChild(renderer.domElement);

    camera.position.y = 1;

    const AmbientLight = new THREE.AmbientLight(0x404040, 0.7);
    scene.add(AmbientLight);

    const textureLoader = new THREE.TextureLoader();

    const skyTexture = textureLoader.load(
      "./texture/OutdoorHDRI024_2K-TONEMAPPED.jpg", () => {
        const rt = new THREE.WebGLCubeRenderTarget(skyTexture.image.height);
        rt.fromEquirectangularTexture(renderer, skyTexture);
        scene.background = rt.texture;
      });

    // //area physics
    // let world = new CANNON.World();
    // world.gravity.set(0, -10, 0);
    // world.broadphase = new CANNON.NaiveBroadphase();
    // let timeStamp = 1.0 / 60.0;

    // let plane = new CANNON.Plane();
    // let planeBody = new CANNON.Body({ shape: plane, mass: 0 });
    // planeBody.quaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), THREE.Math.degToRad(-90));
    // world.addBody(planeBody);

    // let debugRenderer = new THREE.CannonDebugRenderer(scene, world);

    // //box 1
    // let boxG = new CANNON.Box(new CANNON.Vec3(0.5, 0.5, 0.5));
    // let boxBody = new CANNON.Body({ shape: boxG, mass: 5 });
    // boxBody.position.set(0, 5, 0);
    // world.addBody(boxBody);

    let boxGeometry = new THREE.BoxGeometry(1, 2, 1);
    let boxMaterial = new THREE.MeshBasicMaterial({ color: 0xFF00FF });
    let boxMesh = new THREE.Mesh(boxGeometry, boxMaterial);
    boxMesh.position.x = 10
    scene.add(boxMesh);

    let boxGeometry1 = new THREE.BoxGeometry(1, 2, 1);
    let boxMaterial1 = new THREE.MeshBasicMaterial({ color: 0xFF00FF });
    let boxMesh1 = new THREE.Mesh(boxGeometry1, boxMaterial1);
    boxMesh1.position.x = -10
    scene.add(boxMesh1);

    let boxGeometry2 = new THREE.BoxGeometry(1, 2, 1);
    let boxMaterial2 = new THREE.MeshBasicMaterial({ color: 0xFF00FF });
    let boxMesh2 = new THREE.Mesh(boxGeometry2, boxMaterial2);
    boxMesh2.position.z = 10
    scene.add(boxMesh2);

    let boxGeometry3 = new THREE.BoxGeometry(1, 2, 1);
    let boxMaterial3 = new THREE.MeshBasicMaterial({ color: 0xFF00FF });
    let boxMesh3 = new THREE.Mesh(boxGeometry3, boxMaterial3);
    boxMesh3.position.z = -10
    scene.add(boxMesh3);

    // //box 2
    // let boxG2 = new CANNON.Box(new CANNON.Vec3(0.5, 0.5, 0.5));
    // let boxBody2 = new CANNON.Body({ shape: boxG2, mass: 0 });
    // boxBody2.position.set(2, 0, 0);
    // world.addBody(boxBody2);

    // let boxGeometry2 = new THREE.BoxGeometry(1, 1, 1);
    // let boxMaterial2 = new THREE.MeshBasicMaterial({ color: 0xFF00FF });
    // let boxMesh2 = new THREE.Mesh(boxGeometry2, boxMaterial2);
    // scene.add(boxMesh2);

    let controls = new THREE.PointerLockControls(camera, renderer.domElement);

    document.getElementById("lock").addEventListener('click', () => {
      controls.lock();
    });

    let keyboard = [];

    addEventListener("keydown", (e) => {
      keyboard[e.key] = true;
    });

    addEventListener("keyup", (e) => {
      keyboard[e.key] = false;
    });

    function processKeyboard(delta) {
      let speed = 5;
      let actualSpeed = speed * delta;
      let rotationMatrix;
      let cameraDirection = controls.getDirection(new THREE.Vector3(0, 0, 0)).clone();

      if (keyboard['w']) {
        controls.moveForward(actualSpeed);
      }
      if (keyboard['s']) {
        controls.moveForward(-actualSpeed);
        rotationMatrix = new THREE.Matrix4();
        rotationMatrix.makeRotationY(180 * Math.PI / 180);
      }
      if (keyboard['a']) {
        controls.moveRight(-actualSpeed);
        rotationMatrix = new THREE.Matrix4();
        rotationMatrix.makeRotationY(90 * Math.PI / 180);
      }
      if (keyboard['d']) {
        controls.moveRight(actualSpeed);
        rotationMatrix = new THREE.Matrix4();
        rotationMatrix.makeRotationY(270 * Math.PI / 180);
      }

      if (rotationMatrix != null) {
        cameraDirection.applyMatrix4(rotationMatrix);
      }

      let raycaster = new THREE.Raycaster(controls.getObject().position, cameraDirection);
      let intersects = raycaster.intersectObjects(scene.children);

      if (intersects.length > 0) {
        intersects.forEach(object => {
          console.log(object.distance);
        });
      }

    }

    let clock = new THREE.Clock();

    function update() {

      if (controls.isLocked) {
        processKeyboard(clock.getDelta());
      }
      requestAnimationFrame(update);

      renderer.render(scene, camera);
    };

    update();

  </script>
</body>